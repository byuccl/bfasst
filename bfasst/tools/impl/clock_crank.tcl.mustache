{{#opt_design}}
opt_design
{{/opt_design}}

place_design

# Create directories for intermediate checkpoints
file mkdir {{ outputs.post_place_dir }}
file mkdir {{ outputs.post_route_dir }}

# Save checkpoint right after placement, before any phys_opt_design
write_checkpoint -force {{ outputs.pre_phys_opt_dcp }}
write_edif -force {{ outputs.pre_phys_opt_edf }}

set new_period $period
if {[catch {
    set slack [get_property SLACK [lindex [get_timing_paths] 0]]
    if {$slack >= 0 || $slack < -0.5} {
        set new_period [expr {$period - $slack - 0.45}]
    }
}]} {
    catch {
        set slack [get_property DATAPATH_DELAY [lindex [get_timing_paths] 0]]
        set new_period [expr {ceil($slack)}]
    }
}
if {![info exists new_period]} {
    error "Failed to compute new_period - check timing report or variable setup"
}

create_clock -period $new_period -name $clock_name [get_ports $clock_port]

set pre_route_iter 0
while {1} {
    if { [ catch {
        phys_opt_design {{ phys_opt_flags_postplace }}
        report_phys_opt

        # Save intermediate checkpoint
        set iter_str [format "%03d" $pre_route_iter]
        write_checkpoint -force {{ outputs.post_place_dir }}/${iter_str}.dcp
        write_edif -force {{ outputs.post_place_dir }}/${iter_str}.edf
        incr pre_route_iter

        set slack [get_property SLACK [lindex [get_timing_paths] 0]]
        # break
        if {$slack < 0} {break}
        set new_period [expr $new_period - $slack - 0.45]
        create_clock -period $new_period -name $clock_name [get_ports $clock_port]
        puts "New period: $new_period"
    } ] } {
        break
    }
}
route_design
set new_period $period

set post_route_iter 0
while {1} {
    # Try to get slack safely
    set status [catch {
        set slack [get_property SLACK [lindex [get_timing_paths] 0]]
    } err]

    if {$status || $slack eq ""} {
        puts "Failed to retrieve slack: $err"
        break
    }

    # Adjust clock period if slack is outside target window
    if {$slack >= 0 || $slack < -0.2} {
        set new_period [expr {$new_period - $slack - 0.15}]
        create_clock -period $new_period -name $clock_name [get_ports $clock_port]
        puts "Adjusted clock period to: $new_period"
    }

    phys_opt_design {{ phys_opt_flags_postroute }}
    report_phys_opt

    # Save intermediate checkpoint
    set iter_str [format "%03d" $post_route_iter]
    write_checkpoint -force {{ outputs.post_route_dir }}/${iter_str}.dcp
    write_edif -force {{ outputs.post_route_dir }}/${iter_str}.edf
    incr post_route_iter

    # Re-fetch slack after optimization
    set status [catch {
        set slack [get_property SLACK [lindex [get_timing_paths] 0]]
    } err]

    if {$status || $slack eq ""} {
        puts "Failed to retrieve slack after phys_opt: $err"
        break
    }

    if {$slack < 0} {
        puts "Slack is acceptable: $slack â€” exiting loop."
        break
    }
}
