{{#opt_design}}
opt_design -bufg_opt -mbufg_opt
{{/opt_design}}

place_design

set new_period $period
if {[catch {
    set slack [get_property SLACK [lindex [get_timing_paths] 0]]
    if {$slack >= 0 || $slack < -0.5} {
        set new_period [expr {$period - $slack - 0.45}]
    }
}]} {
    catch {
        set slack [get_property DATAPATH_DELAY [lindex [get_timing_paths] 0]]
        set new_period [expr {ceil($slack)}]
    }
}
if {![info exists new_period]} {
    error "Failed to compute new_period - check timing report or variable setup"
}

create_clock -period $new_period -name $clock_name [get_ports $clock_port]

while {1} {
    if { [ catch {
        phys_opt_design -fanout_opt -placement_opt -casc_opt -cell_group_opt -critical_cell_opt -dsp_register_opt -bram_register_opt -bram_enable_opt -shift_register_opt -force_replication_on_nets -critical_pin_opt -memory_rewire_opt -lut_opt -retime -equ_drivers_opt -restruct_opt
        report_phys_opt
        set slack [get_property SLACK [lindex [get_timing_paths] 0]]
        # break
        if {$slack < 0} {break}
        set new_period [expr $new_period - $slack - 0.45]
        create_clock -period $new_period -name $clock_name [get_ports $clock_port]
        puts "New period: $new_period"
    } ] } {
        break
    }
} 
route_design
set new_period $period

while {1} {
    # Try to get slack safely
    set status [catch {
        set slack [get_property SLACK [lindex [get_timing_paths] 0]]
    } err]

    if {$status || $slack eq ""} {
        puts "Failed to retrieve slack: $err"
        break
    }

    # Adjust clock period if slack is outside target window
    if {$slack >= 0 || $slack < -0.2} {
        set new_period [expr {$new_period - $slack - 0.15}]
        create_clock -period $new_period -name $clock_name [get_ports $clock_port]
        puts "Adjusted clock period to: $new_period"
    }

    phys_opt_design -routing_opt -casc_opt -cell_group_opt -critical_cell_opt -critical_pin_opt -clock_opt -memory_rewire_opt
    report_phys_opt

    # Re-fetch slack after optimization
    set status [catch {
        set slack [get_property SLACK [lindex [get_timing_paths] 0]]
    } err]

    if {$status || $slack eq ""} {
        puts "Failed to retrieve slack after phys_opt: $err"
        break
    }

    if {$slack < 0} {
        puts "Slack is acceptable: $slack â€” exiting loop."
        break
    }
}
