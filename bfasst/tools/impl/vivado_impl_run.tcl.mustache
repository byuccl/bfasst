{{#opt_design}}
opt_design
{{/opt_design}}

{{#read_iphys_opt_tcl}}
read_iphys_opt_tcl -placement_opt {{read_iphys_opt_tcl_file}}
{{/read_iphys_opt_tcl}}

place_design 
# -no_timing_driven {{#read_iphys_opt_tcl}} -no_psip {{/read_iphys_opt_tcl}}
write_iphys_opt_tcl -place {{outputs.write_iphys_opt_tcl_file}}
write_checkpoint -force -file {{outputs.post_place_dcp}}

{{#phys_opt_design}}
{{#clocks}}
set period {{period}}
set clock_port {{ name }}
set clock_name {{ name }}_gen
set slack [get_property SLACK [lindex [get_timing_paths] 0]]
# phys_opt does nothing if slack is positive
if {$slack >= 0} {
    set new_period [expr $period - $slack - 0.45]
    create_clock -period $new_period -name $clock_name [get_ports $clock_port]
} elseif {$slack < -0.5} {
    set new_period [expr $period - $slack - 0.45]
    create_clock -period $new_period -name $clock_name [get_ports $clock_port]
}
phys_opt_design
report_phys_opt -file {{ outputs.phys_opt }}_postplace.rpt
write_iphys_opt_tcl -place {{ outputs.phys_opt }}_postplace.tcl
write_checkpoint -force -file {{outputs.post_phys_opt_dcp}}
{{/clocks}}
{{/phys_opt_design}}

route_design

{{#phys_opt_design}}
{{#clocks}}
set slack [get_property SLACK [lindex [get_timing_paths] 0]]
# adjust clock period so 0.0. > slack > -0.2, see UG904 pg. 97, Annotated *IMPORTANT
if {$slack >= 0} {
    set new_period [expr $period - $slack - 0.15]
    create_clock -period $new_period -name $clock_name [get_ports $clock_port]
} elseif {$slack < -0.2} {
    set new_period [expr $period - $slack - 0.15]
    create_clock -period $new_period -name $clock_name [get_ports $clock_port]
}
phys_opt_design -retime
report_phys_opt -file {{ outputs.phys_opt }}_postroute.rpt
write_iphys_opt_tcl -place {{ outputs.phys_opt }}_postroute.tcl
{{/clocks}}
{{/phys_opt_design}}
